<div class="login-wrapper">
  <div class="login-card" *ngIf="step === 'login'">
    <img src="./assets/images/arte/Logo_TransMovi.png" alt="Logo Transmovi" class="logo-header" />
    <h2>Iniciar Sesión</h2>

    <form [formGroup]="loginForm" (ngSubmit)="onSubmit()">
      <div class="input-group">
        <label for="userName">Correo Electrónico:</label>
        <input type="email" formControlName="userName" id="userName" placeholder="Email" autocomplete="username"
          [ngClass]="{ 'is-invalid': submitted && f?.userName?.errors }" />
      </div>

      <div class="input-group">
        <label for="password">Contraseña:</label>
        <input [type]="type" formControlName="password" id="password" placeholder="Contraseña"
          autocomplete="current-password" />
        <span *ngIf="type === 'password'" style="color: rgb(161, 161, 161);" class="eyeButton"
          (click)="myFunctionPasswordCurrent()">
          <i class="fas fa-eye"></i>
        </span>
        <span *ngIf="type === 'text'" style="color: rgb(161, 161, 161);" class="eyeButton"
          (click)="myFunctionPasswordCurrent()">
          <i class="fas fa-eye-slash"></i>
        </span>
      </div>

      <div class="extra-links">
        <a [routerLink]="['/account','afiliacion']">Afiliate</a>
        <a [routerLink]="['/account','reset-password']">¿Olvidaste tu contraseña?</a>
      </div>

      <button class="login-btn" [disabled]="loginForm.invalid || loading"
        style="width: 100%; display: flex; align-items: center; justify-content: center;" type="submit">
        <div class="justigy">
          <span *ngIf="loading" class="loader"></span>
          <span *ngIf="!loading">Ingresar</span>
          <span style="margin-left: 5px;" *ngIf="loading">Cargando...</span>
        </div>
      </button>

      <div style="margin-top: 12px; display:flex; justify-content:center;">
        <button type="button" class="login-btn login-btn--white" (click)="openEmailStep()" style="min-width: 120px;">
          Verificar Cuenta
        </button>
      </div>

    </form>
  </div>

  <div class="login-card" *ngIf="step === 'email'">
    <img src="./assets/images/arte/Logo_TransMovi.png" alt="Logo Transmovi" class="logo-header" />
    <h2>Verificar Cuenta</h2>
    <p style="text-align:center;margin-top:-8px;">Ingresa tu correo para reenviar el código de verificación.</p>

    <form [formGroup]="emailForm" (ngSubmit)="onSendEmail()">
      <div class="input-group">
        <label for="verifyEmail">Correo Electrónico</label>
        <input class="otp-email" id="verifyEmail" type="email" formControlName="userName"
          placeholder="correo@dominio.com" autocomplete="email" />
      </div>

      <div class="extra-links" style="justify-content: space-between;">
        <a (click)="backToLogin()" style="cursor:pointer;">Iniciar Sesión</a>
        <span></span>
      </div>

      <button class="login-btn" [disabled]="emailForm.invalid || loading" type="submit" [attr.aria-busy]="loading"
        style="width: 100%; display:flex; align-items:center; justify-content:center;">
        <div class="justigy" style="display:flex; align-items:center;">
          <span *ngIf="loading" class="loader" style="margin-right:6px;"></span>
          <span>{{ loading ? 'Cargando...' : 'Enviar Correo' }}</span>
        </div>
      </button>

    </form>
  </div>

  <div class="login-card" *ngIf="step === 'otp'" style="max-width: 720px; width: 100%;">

    <img src="./assets/images/arte/Logo_TransMovi.png" alt="Logo Transmovi" class="logo-header" />
    <h2>Ingresa tu código</h2>
    <p style="text-align:center;margin-top:-8px;">
      Ingresa el código de <strong>4 dígitos</strong> que enviamos a tu correo.
    </p>

    <form [formGroup]="verifyForm" (ngSubmit)="onVerify()" autocomplete="one-time-code">
      <div class="otp-inputs" style="display:flex; gap:12px; justify-content:center; margin:16px 0;">
        <input id="otp-box-0" class="otp-box" maxlength="1" inputmode="numeric" pattern="[0-9]*" aria-label="Dígito 1"
          (input)="onOtpInput($event,0)" (keydown)="onOtpKeydown($event,0)" />
        <input id="otp-box-1" class="otp-box" maxlength="1" inputmode="numeric" pattern="[0-9]*" aria-label="Dígito 2"
          (input)="onOtpInput($event,1)" (keydown)="onOtpKeydown($event,1)" />
        <input id="otp-box-2" class="otp-box" maxlength="1" inputmode="numeric" pattern="[0-9]*" aria-label="Dígito 3"
          (input)="onOtpInput($event,2)" (keydown)="onOtpKeydown($event,2)" />
        <input id="otp-box-3" class="otp-box" maxlength="1" inputmode="numeric" pattern="[0-9]*" aria-label="Dígito 4"
          (input)="onOtpInput($event,3)" (keydown)="onOtpKeydown($event,3)" />
      </div>

      <div style="display:flex; gap:12px; justify-content:center; align-items:center;">
        <button class="login-btn" type="submit" [disabled]="verifyForm.invalid || loading" [attr.aria-busy]="loading"
          style="min-width: 220px; display:flex; align-items:center; justify-content:center;">
          <div class="justigy" style="display:flex; align-items:center;">
            <span *ngIf="loading" class="loader" style="margin-right:6px;"></span>
            <span>{{ loading ? 'Cargando...' : 'Verificar' }}</span>
          </div>
        </button>

        <button class="login-btn login-btn--white" type="button" (click)="onResend()"
          [disabled]="resendDisabled || loading">
          Reenviar código <span *ngIf="resendDisabled">({{ resendSeconds }}s)</span>
        </button>

      </div>

      <p *ngIf="resendMsg" style="text-align:center; margin-top:12px;">
        {{ resendMsg }}
      </p>

      <p style="text-align:center; margin-top:8px; color:#666;">
        ¿No recibiste el correo? Revisa tu carpeta de spam o solicita reenviar.
      </p>

      <div class="extra-links" style="justify-content:center; margin-top:8px;">
        <a (click)="openEmailStep()" style="cursor:pointer;">Cambiar correo</a>
        <span style="margin: 0 8px;">•</span>
        <a (click)="backToLogin()" style="cursor:pointer;">Volver</a>
      </div>
    </form>
  </div>
</div>