<div class="container-fluid px-3 px-md-4 py-3 dashboard-wrap">
<!-- dashboard.component.html -->
<div class="dashboard container-fluid px-3 py-3">
    <!-- Filtros de fecha / rango -->
    <div class="row g-2 mt-2">
      <div class="col-12 d-flex justify-content-end flex-wrap gap-2 align-items-end">
        <div class="me-2 mb-2">
          <label class="form-label mb-1">{{ renombrar('Cliente') }}</label>
          <dx-select-box 
            stylingMode="filled" 
            placeholder="Selecciona cliente" 
            [(value)]="clienteSeleccionado"
            [dataSource]="clientesOptions" 
            [valueExpr]="clienteValueExpr" 
            [displayExpr]="clienteDisplayExpr"
            [searchEnabled]="true" 
            [showClearButton]="true" 
            [width]="200"
            (onValueChanged)="onClienteChanged()">
          </dx-select-box>
        </div>
        <div class="me-2 mb-2">
          <label class="form-label mb-1">{{ renombrar('Fecha inicio') }}</label>
          <input type="date" class="form-control form-control-sm" [(ngModel)]="fechaInicio" (change)="obtenerKPIs()" />
        </div>
        <div class="me-2 mb-2">
          <label class="form-label mb-1">{{ renombrar('Fecha fin') }}</label>
          <input type="date" class="form-control form-control-sm" [(ngModel)]="fechaFin" />
        </div>
        <div class="me-2 mb-2 d-flex align-items-end">
          <button type="button" class="btn-filtro buscar" (click)="obtenerKPIs()">
            <i class="fas fa-magnifying-glass"></i> Buscar
          </button>
        </div>
        <div class="mb-2">
          <label class="form-label mb-1">{{ renombrar('Rango') }}</label>
          <select class="form-select form-select-sm" [(ngModel)]="filtroRango" (change)="obtenerKPIsPorRango()">
            <option [value]="1">Al día</option>
            <option [value]="2">Semana (7 días)</option>
            <option [value]="3">Mes</option>
          </select>
        </div>
      </div>
    </div>
  <div class="row g-3">
    <div class="col-12 col-md-6 col-lg-3" *ngFor="let k of kpis">
      <div class="card kpi">
        <div class="kpi-title">{{ renombrar(k.t) }}</div>
        <div class="kpi-value">{{ k.v }}</div>
        <div class="kpi-sub">{{ renombrar(k.s) }}</div>
      </div>
    </div>
  </div>

  <div class="row g-2 mt-2" *ngIf="etiquetasOriginales?.length">
    <div class="col-auto" *ngFor="let e of etiquetasOriginales">
      <span class="badge bg-secondary">{{ renombrar(e) }}</span>
    </div>
  </div>

  <div class="row g-3 mt-1">
    <div class="col-12 col-lg-6">
      <div class="card chart-card">
        <div class="card-title">{{ renombrar('Ingresos por hora (hoy)') }}</div>
        <dx-chart [dataSource]="dsIngresosHora" [palette]="palette" [size]="{ height: 320 }">
          <dxo-legend position="bottom"></dxo-legend>
          <dxo-argument-axis argumentType="string"></dxo-argument-axis>
          <dxo-tooltip [enabled]="true" [customizeTooltip]="customizeIngresosTooltip"></dxo-tooltip>
          <dxi-value-axis name="money">
            <dxo-label [format]="{ type: 'currency', precision: 2 }"></dxo-label>
          </dxi-value-axis>
          <dxi-value-axis name="ticket"></dxi-value-axis>
          <dxi-series type="bar" name="Ingresos" argumentField="hora" valueField="ingreso" axis="money"></dxi-series>
          <dxi-series type="line" name="Ticket promedio" argumentField="hora" valueField="ticket" axis="ticket"></dxi-series>
        </dx-chart>
      </div>
    </div>

    <div class="col-12 col-lg-6">
      <div class="card chart-card">
        <div class="card-title">{{ renombrar('Pasajeros por ruta') }}</div>
        <dx-chart
  [dataSource]="dsPasajerosPorHora"
  [series]="seriesPasajeros"
  [palette]="palette"
  [size]="{ height: 320 }">
  <dxo-common-series-settings type="stackedBar" argumentField="hora"></dxo-common-series-settings>
  <dxo-legend position="bottom"></dxo-legend>
  <dxo-argument-axis argumentType="string"></dxo-argument-axis>
</dx-chart>

      </div>
    </div>

    <div class="col-12 col-lg-6">
      <div class="card chart-card">
        <div class="card-title">{{ renombrar('Ascensos vs. boletos') }}</div>
        <dx-chart [dataSource]="dsBrecha" [palette]="palette" [size]="{ height: 320 }">
          <dxo-legend position="bottom"></dxo-legend>
          <dxo-argument-axis argumentType="string"></dxo-argument-axis>
          <dxi-series type="line" name="Ascensos" argumentField="hora" valueField="ascensos"></dxi-series>
          <dxi-series type="line" name="Boletos" argumentField="hora" valueField="boletos"></dxi-series>
        </dx-chart>
      </div>
    </div>

    <div class="col-12 col-lg-3">
      <div class="card chart-card">
        <div class="card-title">{{ renombrar('Medios de pago') }}</div>
        <dx-pie-chart [dataSource]="dsMediosPago" [palette]="palette" [size]="{ height: 320 }">
          <dxi-series type="doughnut" argumentField="medio" valueField="valor"></dxi-series>
          <dxo-legend position="bottom"></dxo-legend>
        </dx-pie-chart>
      </div>
    </div>

    <div class="col-12 col-lg-3">
      <div class="card chart-card">
        <div class="card-title">{{ renombrar('Puntualidad inicio de viaje') }}</div>
        <dx-chart [dataSource]="dsPuntualidad" [palette]="palette" [size]="{ height: 320 }">
          <dxo-legend [visible]="false"></dxo-legend>
          <dxo-argument-axis argumentType="string"></dxo-argument-axis>
          <dxi-series type="bar" argumentField="bin" valueField="viajes" name="Viajes"></dxi-series>
        </dx-chart>
      </div>
    </div>
  </div>

  <div class="row g-3 mt-1">
    <div class="col-12 col-xl-6">
      <div class="card list-card">
        <div class="card-title">{{ renombrar('Top 5 rutas por ingreso') }}</div>
        <dx-data-grid class="dx-grid-dark" [dataSource]="topRutas" [columnAutoWidth]="true" [rowAlternationEnabled]="true" [showBorders]="false">
          <dxi-column dataField="nombre" [caption]="renombrar('Ruta')"></dxi-column>
          <dxi-column dataField="ingresos" [caption]="renombrar('Ingresos')" dataType="number" format="currency" alignment="right"></dxi-column>
          <dxi-column dataField="viajes" [caption]="renombrar('Viajes')" dataType="number" alignment="center"></dxi-column>
        </dx-data-grid>
      </div>
    </div>

    <div class="col-12 col-xl-6">
      <div class="card list-card">
        <div class="card-title">{{ renombrar('Dispositivos con alertas') }}</div>
        <dx-data-grid class="dx-grid-dark" [dataSource]="dispositivosConAlertas" [rowAlternationEnabled]="true" [showBorders]="false">
          <dxi-column dataField="nombre" [caption]="renombrar('Equipo')"></dxi-column>
          <dxi-column dataField="motivo" [caption]="renombrar('Motivo')"></dxi-column>
          <dxi-column dataField="minSinPos" [caption]="renombrar('Min sin posición')" dataType="number" alignment="center"></dxi-column>
          <dxi-column dataField="estatus" [caption]="renombrar('Estatus')" alignment="center"></dxi-column>
          <dxi-column [caption]="renombrar('Tipo')" cellTemplate="tipoTpl"></dxi-column>
          <ng-template dxTemplate="tipoTpl" let-data>
            <span class="chip" [ngClass]="data.data.tipo">{{ renombrar(data.data.tipo) }}</span>
          </ng-template>
        </dx-data-grid>
      </div>
    </div>
  </div>
</div>

</div>