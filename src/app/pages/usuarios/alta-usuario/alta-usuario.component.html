<div [@fadeInUp] class="container-fluid">
  <div class="card">
    <div class="card-header-custom">
      <div class="icon-wrapper">
        <i class="fas fa-user-plus"></i>
      </div>
      <div class="header-text">
        <h5>{{ title }}</h5>
        <span>Completa la información para registrar un nuevo usuario.</span>
      </div>
    </div>
    <div class="card-body">
      <form [formGroup]="usuarioForm" class="cliente-form" (ngSubmit)="submit()">
        <h6 class="section-title">Datos Generales</h6>
        <div class="row">
          <div class="col-12 col-sm-6 col-md-4 col-lg-4 col-xl-4 mt-2">
            <label>Nombre</label>
            <input type="text" class="form-control" formControlName="nombre"
              placeholder="Ej: Comercializadora Ejemplo" />
          </div>
          <div class="col-12 col-sm-6 col-md-4 col-lg-4 col-xl-4 mt-2">
            <label>Apellido Paterno</label>
            <input type="text" class="form-control" formControlName="apellidoPaterno" placeholder="Ej: Rodríguez" />
          </div>
          <div class="col-12 col-sm-6 col-md-4 col-lg-4 col-xl-4 mt-2">
            <label>Apellido Materno</label>
            <input type="text" class="form-control" formControlName="apellidoMaterno" placeholder="Ej: Santos" />
          </div>
          <div class="col-12 col-sm-6 col-md-4 col-lg-4 col-xl-4 mt-2">
            <label>Teléfono</label>
            <input maxlength="10" (keypress)="allowOnlyNumbers($event)" class="form-control" formControlName="telefono"
              placeholder="Ej: 5555555555" />
          </div>
          <div class="col-12 col-sm-6 col-md-4 col-lg-4 col-xl-4 mt-2" *ngIf="inputContrasena">
            <label>Correo</label>
            <input type="email" class="form-control" formControlName="userName"
              placeholder="Ej: contacto@ejemplo.com" />
          </div>
          <div class="col-12 col-sm-6 col-md-4 col-lg-4 col-xl-4 mt-2">
            <label>Rol</label>
            <select class="form-control" formControlName="idRol">
              <option [ngValue]="null" disabled>Seleccione un rol</option>
              <option *ngFor="let r of listaRoles" [value]="r.id">
                {{ r.nombre || r.Nombre || ('Rol ' + (r.id || r.Id)) }}
              </option>
            </select>
          </div>
          <div class="col-12 col-sm-6 col-md-3 col-lg-3 col-xl-3 mt-2">
            <label>Cliente</label>
            <select class="form-control" formControlName="idCliente">
              <option [ngValue]="null" disabled>Seleccione un cliente</option>
              <option *ngFor="let c of listaClientes" [ngValue]="c.id">
                {{ (c.nombre || '') + ' ' + (c.apellidoPaterno || '') }}
              </option>
            </select>
          </div>
          <div class="col-12 col-sm-6 col-md-3 col-lg-3 col-xl-3 mt-2" *ngIf="inputContrasena">
            <label id="pws1">Contraseña</label>
            <div class="password-wrapper">
              <input (keyup)="onPasswordInput($event)" [type]="type" autocomplete="new-password" class="form-control"
                pattern="^(?=.*\d)(?=.*[a-z])(?=.*[A-Z])(?=.*[a-zA-Z]).{6,}$" formControlName="passwordHash"
                placeholder="******" />
              <span *ngIf="type == 'password'" class="eyeButton" (click)="myFunctionPasswordCurrent()" matSuffix>
                <i class="fa fa-eye"></i>
              </span>
              <span *ngIf="type == 'text'" class="eyeButton" (click)="myFunctionPasswordCurrent()" matSuffix>
                <i class="fa fa-eye-slash"></i>
              </span>
            </div>
            <span *ngIf="usuarioForm.get('passwordHash')?.errors?.required && usuarioForm.get('passwordHash')?.touched"
              class="text-danger">Campo requerido</span>
            <div class="mt-3 password-requirements">
              <p class="mb-0">
                <i class="fa fa-check-circle" [ngClass]="{ checked: minCaracteres && maxCaracteres }"
                  aria-hidden="true"></i>
                La contraseña debe tener más de 6 caracteres y menos de 16.
              </p>
              <p class="mb-0">
                <i class="fa fa-check-circle" [ngClass]="{ checked: hasMayus && hasMinus }" aria-hidden="true"></i>
                Al menos una mayúscula y minúsculas.
              </p>
              <p class="mb-0">
                <i class="fa fa-check-circle" [ngClass]="{ checked: espCaracter }" aria-hidden="true"></i>
                Un caracter no alfanumérico (ejemplo: #?!&).
              </p>
              <p class="mb-0">
                <i class="fa fa-check-circle" [ngClass]="{ checked: hasNumber }" aria-hidden="true"></i>
                Un número.
              </p>
            </div>
          </div>
          <div class="col-12 col-sm-6 col-md-3 col-lg-3 col-xl-3 mt-2" *ngIf="inputContrasena">
            <label id="pws2">Confirmar Contraseña</label>
            <div class="password-wrapper">
              <input [type]="typeConfirm" class="form-control" placeholder="******" formControlName="confirmPassword"
                autocomplete="new-password" />
              <span *ngIf="typeConfirm == 'password'" class="eyeButton" (click)="toggleConfirmPassword()">
                <i class="fa fa-eye"></i>
              </span>
              <span *ngIf="typeConfirm == 'text'" class="eyeButton" (click)="toggleConfirmPassword()">
                <i class="fa fa-eye-slash"></i>
              </span>
            </div>
            <span *ngIf="usuarioForm.hasError('passwordMismatch') && usuarioForm.get('confirmPassword')?.touched"
              class="text-danger">Las contraseñas no coinciden</span>
          </div>
          <div class="col-12 col-sm-6 col-md-3 col-lg-3 col-xl-3 mt-2">
            <div class="tc-upload">
              <label>Logotipo</label>
              <div class="tc-preview" *ngIf="logoPreviewUrl; else logoTile">
                <img [src]="logoPreviewUrl" alt="Logotipo" />
                <div class="tc-actions">
                  <button type="button" class="btn-change" (click)="openLogoFilePicker()">Cambiar</button>
                  <button type="button" class="btn-remove" (click)="clearLogoImage($event)">
                    <i class="fas fa-times"></i>
                  </button>
                </div>
              </div>
              <ng-template #logoTile>
                <div class="tc-tile" (click)="openLogoFilePicker()" (dragover)="onLogoDragOver($event)"
                  (dragleave)="onLogoDragLeave($event)" (drop)="onLogoDrop($event)" [class.dragging]="logoDragging">
                  <div class="circle"><i class="fas fa-image"></i></div>
                  <div class="meta">
                    <div class="title">Arrastra o haz clic para subir su logotipo</div>
                    <div class="hint">JPG/PNG/WEBP/PDF/DOC/XLS · máx 3 MB</div>
                  </div>
                </div>
              </ng-template>
              <input type="file" #logoFileInput accept=".jpg,.jpeg,.png,.webp,.pdf,.doc,.docx,.xls,.xlsx" hidden
                (change)="onLogoFileSelected($event)">
            </div>
          </div>
        </div>
        <div class="mp">
          <div class="mp-head">
            <h6 class="section-title">Permisos</h6>
            <div class="mp-sub">Asigna las acciones y accesos disponibles para el usuario.</div>
          </div>
          <div class="mp-grid">
            <div class="mp-card" *ngFor="let modulo of listaModulos; trackBy: trackModulo">
              <div class="mp-ch">
                <div class="mp-ct">
                  <div class="mp-av">{{ (modulo?.nombre || 'M') | slice: 0:1 }}</div>
                  <div class="mp-ctxt">
                    <h5 class="text-truncate" [title]="modulo?.nombre">{{ modulo?.nombre }}</h5>
                    <small class="text-muted text-truncate" [title]="modulo?.descripcion || ''">
                      {{ modulo?.descripcion || 'Sin descripción' }}
                    </small>
                  </div>
                </div>
                <div class="mp-badge">{{ modulo?.permisos?.length || 0 }}</div>
              </div>
              <div class="mp-cb" *ngIf="modulo?.permisos?.length; else noPerms">
                <div class="perm-list">
                  <div class="perm-row" *ngFor="let permiso of modulo.permisos; trackBy: trackPermiso">
                    <div class="perm-text">
                      <div class="perm-name" [title]="permiso?.nombre">{{ permiso?.nombre }}</div>
                      <div class="perm-desc" [title]="permiso?.descripcion || ''">{{ permiso?.descripcion || '—' }}
                      </div>
                    </div>
                    <div class="perm-switch">
                      <label class="sw">
                        <input type="checkbox" [checked]="isPermisoAsignado(permiso?.id)"
                          (change)="onToggle(permiso, $any($event.target).checked)" />
                        <span class="sl"></span>
                      </label>
                    </div>
                  </div>
                </div>
              </div>
              <ng-template #noPerms>
                <div class="mp-empty">Este módulo no tiene permisos</div>
              </ng-template>
            </div>
          </div>
        </div>
        <div class="form-actions mt-5">
          <button type="submit" class="submit">{{ submitButton }}</button>
          <button type="button" class="cancel" (click)="regresar()">Cancelar</button>
        </div>
      </form>
    </div>
  </div>
</div>